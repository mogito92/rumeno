<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Andrei: Caccia al Rame</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            touch-action: none; /* Impedisce zoom e scroll su Android */
            font-family: 'Press Start 2P', cursive;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            z-index: 10;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }

        .hud-text {
            font-size: 14px;
            margin-bottom: 5px;
            color: #FFD700;
        }

        #startScreen, #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 20;
            text-align: center;
        }

        h1 { color: #e77f24; font-size: 24px; text-transform: uppercase; line-height: 1.5; }
        p { font-size: 12px; color: #ccc; line-height: 1.8; max-width: 80%; }
        
        .btn {
            margin-top: 20px;
            padding: 15px 30px;
            background: #2ecc71;
            border: 4px solid #27ae60;
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
            animation: pulse 1s infinite;
        }

        .btn:active { background: #27ae60; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Effetto flash per TNT */
        #flash {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
            z-index: 15;
        }
    </style>
</head>
<body>

    <div id="ui">
        <div class="hud-text">RAME: <span id="scoreVal">0</span> KG</div>
        <div class="hud-text">VITA: <span id="healthVal">100</span>%</div>
        <div class="hud-text" id="waveText" style="color:#aaf;">GIORNO: SCAVA!</div>
    </div>

    <div id="startScreen">
        <h1>Andrei<br>Cacciatore di Rame</h1>
        <p>Ciao Andrei.<br>Tocca i blocchi per scavare.<br>Raccogli il RAME.<br>Usa la TNT per i nemici.<br>Non farti prendere il portafoglio.</p>
        <button class="btn" onclick="startGame()">ANDIAMO!</button>
    </div>

    <div id="gameOverScreen" style="display: none;">
        <h1 style="color:red">SEI STATO PRESO!</h1>
        <p>Hai perso tutto il rame...</p>
        <p>Totale: <span id="finalScore">0</span> KG</p>
        <button class="btn" onclick="startGame()">Riprova</button>
    </div>

    <div id="flash"></div>
    <canvas id="gameCanvas"></canvas>

<script>
    // --- SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('scoreVal');
    const healthEl = document.getElementById('healthVal');
    const waveEl = document.getElementById('waveText');
    const flashEl = document.getElementById('flash');
    
    let width, height;
    let particles = [];
    let entities = [];
    let score = 0;
    let health = 100;
    let gameRunning = false;
    let frame = 0;
    let difficulty = 1;
    let isNight = false;
    let dayCycleTimer = 0;
    
    // Audio Context (Synthesizer)
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'hit') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'copper') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        } else if (type === 'tnt') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }
    }

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- CLASSI ---

    class Entity {
        constructor(type) {
            this.size = width < 600 ? 50 : 70; // Grandezza adattiva
            this.x = Math.random() * (width - this.size);
            this.y = -this.size;
            this.type = type;
            this.markedForDeletion = false;
            
            // Velocità basata sulla difficoltà
            this.speed = (Math.random() * 2 + 2) * (1 + difficulty * 0.1);
            
            // Proprietà visuali
            if (type === 'copper') {
                this.color = '#e77f24'; // Rame
                this.hp = 1;
                this.score = 5;
            } else if (type === 'diamond') {
                this.color = '#00ffff';
                this.hp = 2;
                this.score = 50;
                this.speed *= 1.5; // Più veloce
            } else if (type === 'stone') {
                this.color = '#7d7d7d';
                this.hp = 3;
                this.score = 1;
            } else if (type === 'tnt') {
                this.color = '#ff0000';
                this.hp = 1;
                this.score = 0;
            } else if (type === 'creeper') {
                this.color = '#00aa00';
                this.hp = 2;
                this.damage = 20;
            } else if (type === 'enderman') {
                this.color = '#111';
                this.hp = 4;
                this.damage = 30;
                this.speed *= 1.3;
            }
        }

        update() {
            this.y += this.speed;
            
            // Se tocca il fondo
            if (this.y > height) {
                this.markedForDeletion = true;
                if (['creeper', 'enderman'].includes(this.type)) {
                    takeDamage(this.damage);
                }
            }
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);

            // Disegna il blocco stile Minecraft (bordo + centro)
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, this.size, this.size); // Bordo
            ctx.fillStyle = this.color;
            ctx.fillRect(4, 4, this.size - 8, this.size - 8); // Interno

            // Texture specifiche
            if (this.type === 'copper' || this.type === 'diamond') {
                ctx.fillStyle = '#fff';
                ctx.globalAlpha = 0.5;
                ctx.fillRect(10, 10, 10, 10);
                ctx.fillRect(this.size-20, this.size-20, 8, 8);
                ctx.globalAlpha = 1;
            }
            if (this.type === 'tnt') {
                ctx.fillStyle = '#fff';
                ctx.font = '12px "Press Start 2P"';
                ctx.fillText("TNT", 10, this.size/2 + 5);
                // Strisce
                ctx.fillStyle = '#ccc';
                ctx.fillRect(4, 15, this.size-8, 5);
            }
            if (this.type === 'creeper') {
                ctx.fillStyle = '#000';
                // Faccia Creeper
                ctx.fillRect(10, 10, 10, 10); // Occhio sx
                ctx.fillRect(this.size-20, 10, 10, 10); // Occhio dx
                ctx.fillRect(this.size/2 - 5, 20, 10, 15); // Naso
                ctx.fillRect(15, 35, this.size-30, 10); // Bocca
            }
            if (this.type === 'enderman') {
                ctx.fillStyle = '#d0f';
                ctx.fillRect(5, 15, 15, 5); // Occhi
                ctx.fillRect(this.size-20, 15, 15, 5);
            }

            ctx.restore();
        }

        hit() {
            this.hp--;
            createParticles(this.x + this.size/2, this.y + this.size/2, this.color);
            playSound('hit');

            if (this.hp <= 0) {
                this.markedForDeletion = true;
                
                if (this.type === 'tnt') {
                    explodeTNT();
                } else if (['copper', 'diamond', 'stone'].includes(this.type)) {
                    score += this.score;
                    playSound('copper');
                    scoreEl.innerText = score;
                } else {
                    // Nemici uccisi
                    score += 10;
                    scoreEl.innerText = score;
                }
            } else {
                // Effetto "hit" bianco
                ctx.save();
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.restore();
            }
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.size = Math.random() * 8 + 4;
            this.speedX = Math.random() * 6 - 3;
            this.speedY = Math.random() * 6 - 3;
            this.life = 1;
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.life -= 0.05;
        }
        draw() {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.size, this.size);
            ctx.globalAlpha = 1;
        }
    }

    // --- LOGICA DI GIOCO ---

    function createParticles(x, y, color) {
        for (let i = 0; i < 5; i++) {
            particles.push(new Particle(x, y, color));
        }
    }

    function takeDamage(amount) {
        health -= amount;
        healthEl.innerText = Math.max(0, health);
        document.body.style.backgroundColor = '#500'; // Flash rosso bg
        setTimeout(() => document.body.style.backgroundColor = '#000', 100);
        
        if (health <= 0) {
            endGame();
        }
    }

    function explodeTNT() {
        playSound('tnt');
        flashEl.style.opacity = 0.8;
        setTimeout(() => flashEl.style.opacity = 0, 200);
        
        // Uccide tutti i nemici visibili
        entities.forEach(e => {
            if (['creeper', 'enderman', 'stone'].includes(e.type)) {
                e.hp = 0;
                e.markedForDeletion = true;
                createParticles(e.x, e.y, e.color);
            }
        });
        score += 50; // Bonus TNT
        scoreEl.innerText = score;
    }

    function spawner() {
        if (frame % 40 === 0) { // Frequenza spawn
            let type;
            let rand = Math.random();

            if (isNight) {
                // Notte: Più nemici
                if (rand < 0.6) type = 'creeper';
                else if (rand < 0.9) type = 'enderman';
                else type = 'tnt';
            } else {
                // Giorno: Più risorse
                if (rand < 0.5) type = 'copper';
                else if (rand < 0.8) type = 'stone';
                else if (rand < 0.95) type = 'diamond';
                else type = 'tnt';
            }
            entities.push(new Entity(type));
        }
    }

    // Gestione input (Mouse e Touch unificati)
    function handleInput(e) {
        if (!gameRunning) return;
        e.preventDefault(); // Stop zoom

        // Ottieni coordinate
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        // Effetto piccone (cursore visivo temporaneo)
        createParticles(clientX, clientY, '#fff');

        // Controlla collisioni con entità
        for (let i = entities.length - 1; i >= 0; i--) {
            let ent = entities[i];
            if (clientX > ent.x && clientX < ent.x + ent.size &&
                clientY > ent.y && clientY < ent.y + ent.size) {
                ent.hit();
                return; // Colpisci solo uno alla volta
            }
        }
    }

    canvas.addEventListener('mousedown', handleInput);
    canvas.addEventListener('touchstart', handleInput, {passive: false});

    function gameLoop() {
        if (!gameRunning) return;

        ctx.clearRect(0, 0, width, height);

        // Sky background
        ctx.fillStyle = isNight ? '#000033' : '#87CEEB';
        ctx.fillRect(0, 0, width, height);
        
        // Ciclo giorno notte
        dayCycleTimer++;
        if (dayCycleTimer > 1000) {
            isNight = !isNight;
            dayCycleTimer = 0;
            waveEl.innerText = isNight ? "NOTTE: DIFENDI!" : "GIORNO: SCAVA!";
            waveEl.style.color = isNight ? "#ff5555" : "#aaf";
            difficulty += 0.5; // Aumenta difficoltà ogni notte
        }

        spawner();

        // Update entities
        entities.forEach(e => {
            e.update();
            e.draw();
        });
        entities = entities.filter(e => !e.markedForDeletion);

        // Update particles
        particles.forEach(p => {
            p.update();
            p.draw();
        });
        particles = particles.filter(p => p.life > 0);

        frame++;
        requestAnimationFrame(gameLoop);
    }

    function startGame() {
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('gameOverScreen').style.display = 'none';
        score = 0;
        health = 100;
        difficulty = 1;
        entities = [];
        particles = [];
        scoreEl.innerText = '0';
        healthEl.innerText = '100';
        gameRunning = true;
        isNight = false;
        waveEl.innerText = "GIORNO: SCAVA!";
        
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        requestAnimationFrame(gameLoop);
    }

    function endGame() {
        gameRunning = false;
        document.getElementById('finalScore').innerText = score;
        document.getElementById('gameOverScreen').style.display = 'flex';
    }

</script>
</body>
</html>